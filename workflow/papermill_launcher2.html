

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial: processing several tags with kbatch_papermill &mdash; Global Fish Tracking System (GFTS) - DestinE Platform use case</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
      <link rel="stylesheet" type="text/css" href="../_static/exercise.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/code-style.css?v=633ae332" />
      <link rel="stylesheet" type="text/css" href="../_static/xarray-style.css?v=7b4ed5f0" />
      <link rel="stylesheet" type="text/css" href="../_static/service-doc.css?v=d72d29cf" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=a681ed88"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/scripts/sphinx-book-theme.js"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
      <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Scientific Validation of the results" href="scientific_validation.html" />
    <link rel="prev" title="2. Estimation of fish locations" href="geolocation_model_execution.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../intro.html" class="icon icon-home">
            Global Fish Tracking System
              <img src="../_static/logomark.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GFTS_Use_Case_Description.html">The GFTS Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_of_conduct.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rule_of_participation.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rule_of_participation.html#rules-of-participation">Rules of participation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rule_of_participation.html#how-to-ask-the-inclusion-of-a-new-project">How to ask the inclusion of a new project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rule_of_participation.html#community">Community</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Onboarding new users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../new2gfts.html">GFTS Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow.html">GFTS Workflow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Workflow</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="input_data_preparation.html">1. Data Preparation for <code class="docutils literal notranslate"><span class="pre">pangeo_fish</span></code></a></li>
<li class="toctree-l1 current"><a class="reference internal" href="geolocation_model_execution.html">2. Estimation of fish locations</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Tutorial: processing several tags with <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scientific_validation.html">3. Scientific Validation of the results</a></li>
<li class="toctree-l1"><a class="reference internal" href="result_publication.html">4. Result Publication</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../other_examples_overview.html">Example Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CopernicusMarine.html">Copernicus Marine for GFTS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tag_data.html">Intro to Biologging data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tag_data_summary.html">Tool: How to summarize the tag data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tag_data_summary.html#notebook-initialization">0. Notebook Initialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tag_data_summary.html#release-locations-overview">1. Release Locations Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tag_data_summary.html#summary-table">2. Summary Table</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s3_CMEMS_2D_kerchunk.html">Create Kerchunk catalog for CMEMS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s3_CMEMS_3D_kerchunk.html">Create Kerchunk catalog for CMEMS 3D</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s3chunked_parquet.html">Read parquet kerchunk catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmems_catalog_creation.html">Copernicus data exploration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gfts_intake.html">Reading CMEMS Copernicus data from GFTS s3 bucket</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compute_3D_pdf.html">Computing 3D PDF from State matrix and tag pressure information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ClimateDT-zarr-2D-3D.html">Extract selected area from DestinE Climate Twin in Healpix to Zarr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visu3Dvista.html">Visualize bathymetry with pyvista</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reporting &amp; Outreach</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deliverables.html">Project deliverables and reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outreach.html">Conferences and other events</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GFTS Technical Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../system/gfts_components.html">Overview of GFTS System Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/gfts_hub.html">GFTS JupyterHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/gfts_service.html">GFTS Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/admin_doc.html">Documentation Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/gfts_github_actions.html">GFTS Verification and Validation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../intro.html">Global Fish Tracking System</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../intro.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="geolocation_model_execution.html">2. Estimation of fish locations</a></li>
      <li class="breadcrumb-item active">Tutorial: processing several tags with <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code></li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/workflow/papermill_launcher2.ipynb" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="tutorial-processing-several-tags-with-kbatch-papermill">
<h1>Tutorial: processing several tags with <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code><a class="headerlink" href="#tutorial-processing-several-tags-with-kbatch-papermill" title="Link to this heading"></a></h1>
<p>In this tutorial, we cover the handling of the processing of your biologging data, from hereafter referred to as <em>tags</em>.</p>
<p>Here, we will illustrate the case where you want to run the fish tracking estimation model implemented by <code class="docutils literal notranslate"><span class="pre">pangeo-fish</span></code> <em>entirely</em>, for all your tags.</p>
<p>As a biologist, you might wonder how to run the estimation model on all these data…</p>
<p>This tutorial aims to clarify this point, by providing you <em>a way</em> to automatically scale this processing!</p>
<p>The overall idea is the following:</p>
<ol class="arabic simple">
<li><p>First, you write a Jupyter notebook that will perform all the operations you want for a tag (using some functions of <code class="docutils literal notranslate"><span class="pre">pangeo-fish</span></code>). It can be computing data, plotting some of the results along the way, checking the data as the cells go on etc.</p></li>
<li><p>Then, thanks to a <em>launcher notebook</em> we are going to learn to write here, you run <em>all the tags at once</em>, with whatever HPC resource you have access to.</p></li>
</ol>
<p><strong>Note that this workflow is compatible for any time of computation.</strong>
That being said, please be aware of the following limitations (and pitfalls):</p>
<ol class="arabic simple">
<li><p>“Inside” the HPC, the notebooks will be run in containers, whose local storage is lost once the notebook is executed. As such, if the latter saves some data, make sure to send it somewhere (typically, to a S3 bucket).</p></li>
<li><p>Since the run notebooks are retrieved after their execution, any interactive plot won’t be shown. Therefore, we recommend considering either saving them (as HTML file for example) and adding cells in the notebook that would statically plot an equivalent plot.</p></li>
</ol>
<section id="technologies-behind-the-launcher-notebook">
<h2>Technologies behind the <em>launcher notebook</em><a class="headerlink" href="#technologies-behind-the-launcher-notebook" title="Link to this heading"></a></h2>
<p>The workflow covered in this tutorial, the <em>launcher notebook</em>, relies on <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code>, a package that lets you parametrize notebooks <em>and</em> run them as jobs.</p>
<p>Specifically <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code> is built on top of <a class="reference external" href="https://papermill.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">papermill</span></code></a>, a Python library that enable parameterized execution of Jupyter notebooks.
<code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code> provides a convenient API for running the aforementioned notebooks as jobs on your cluster.</p>
<p>In fact, <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code> has been primarily designed for this use-case!</p>
<p>To summarize, in this tutorial notebook, you will learn how to write a <em>launcher notebook</em>.
Here, the routine we will set up is <strong>the generation of fish location estimations</strong> for your tags.</p>
<!-- First we define important parameters that will be used in the loop that executes the notebooks.
The second part will generate ipynb files, based on a template noteboook, with the modified parameters, defined in the first cells of the notebook --><p>Before we set out to do anything, let’s import all the required Python packages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">s3fs</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">kbatch_papermill</span><span class="w"> </span><span class="kn">import</span> <span class="n">kbatch_papermill</span><span class="p">,</span> <span class="n">print_job_status</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="main-inputs-for-launcher-notebook">
<h2>Main inputs for <em>launcher notebook</em><a class="headerlink" href="#main-inputs-for-launcher-notebook" title="Link to this heading"></a></h2>
<section id="a-details">
<h3>a. Details<a class="headerlink" href="#a-details" title="Link to this heading"></a></h3>
<p>In a nutshell, the notebook consists of submitting jobs to your HPC resources where the tasks are a parametrized notebook.</p>
<p>The function used to submit the jobs is <a class="reference external" href="https://kbatch-papermill.readthedocs.io/en/latest/api.html#kbatch_papermill.kbatch_papermill"><code class="docutils literal notranslate"><span class="pre">kbatch_papermill.kbatch_papermill</span></code></a>, which requires:</p>
<ol class="arabic simple">
<li><p>Information about the notebook:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">code_dir</span></code>: path to the folder containing the notebook. <strong>The folder will be copied alongside the notebook itself</strong>, allowing you to have access to any necessary file for your tasks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">notebook</span></code>: the path to the notebook itself, relative to <code class="docutils literal notranslate"><span class="pre">code_dir</span></code>.</p></li>
</ul>
</li>
<li><p>Information about the remote storage of the notebook:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">s3_dest</span></code>: the uri to save the notebook (once executed)</p></li>
</ul>
</li>
</ol>
<p><em>NB: <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code> does have more parameters, that you might be interested in using once you have gained more experience. In this tutorial, we will define them for you!</em></p>
</section>
<section id="b-application">
<h3>b. Application<a class="headerlink" href="#b-application" title="Link to this heading"></a></h3>
<p>First, clone the <code class="docutils literal notranslate"><span class="pre">pangeo-fish</span></code>’s repository to have the notebook:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># in a new terminal</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/pangeo-fish/pangeo-fish.git<span class="w"> </span>pangeo-fish
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># input/local variables</span>
<span class="n">code_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;pangeo-fish&quot;</span>
<span class="n">notebook</span> <span class="o">=</span> <span class="s2">&quot;notebooks/pangeo-fish.ipynb&quot;</span>

<span class="c1"># where to store the result of this tutorial</span>
<span class="n">s3_dest</span> <span class="o">=</span> <span class="s2">&quot;s3://gfts-ifremer/kbatch_papermill/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># additional variables</span>
<span class="n">user_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;JUPYTERHUB_USER&quot;</span><span class="p">)</span>
<span class="n">storage_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;anon&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;client_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;endpoint_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://s3.gra.perf.cloud.ovh.net&quot;</span><span class="p">,</span>
        <span class="s2">&quot;region_name&quot;</span><span class="p">:</span> <span class="s2">&quot;gra&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="c1"># appends to `s3_dest` your username</span>
<span class="n">s3_dest</span> <span class="o">+=</span> <span class="n">user_name</span>
<span class="n">s3_nb_dest</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s3_dest</span><span class="si">}</span><span class="s2">/nbs&quot;</span>  <span class="c1"># the notebooks will be stored in a dedicated directory &quot;nbs&quot;</span>
<span class="p">)</span>
<span class="c1"># remote accessor</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">s3</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">s3_nb_dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remote storage root:&quot;</span><span class="p">,</span> <span class="n">s3_dest</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remote storage root for the notebooks:&quot;</span><span class="p">,</span> <span class="n">s3_nb_dest</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Additionally, let’s define a folder where we will save:</p>
<ol class="arabic simple">
<li><p>Metadata of what we run (in a <code class="docutils literal notranslate"><span class="pre">.json</span></code> file <code class="docutils literal notranslate"><span class="pre">jobs.json</span></code>)</p></li>
<li><p>Fetch the remotely stored notebooks (once they are executed)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">local_output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;notebook_launcher_tutorial&quot;</span><span class="p">)</span>
<span class="n">local_output</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">job_dict</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="parametrizing-and-launching-notebooks">
<h2>Parametrizing and launching notebooks<a class="headerlink" href="#parametrizing-and-launching-notebooks" title="Link to this heading"></a></h2>
<section id="id1">
<h3>a. Details<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>In this tutorial, we simply run the example notebook included in the <code class="docutils literal notranslate"><span class="pre">pangeo-fish</span></code>’s repository, with different tag names.</p>
<p>To do so, we need to change the variable <code class="docutils literal notranslate"><span class="pre">tag_name</span></code> of the notebook, since it corresponds to the name of the tag to process.
For instance, let’s run it for the tags <code class="docutils literal notranslate"><span class="pre">A19124</span></code>, <code class="docutils literal notranslate"><span class="pre">A18831</span></code> and <code class="docutils literal notranslate"><span class="pre">A18832</span></code>.</p>
</section>
<section id="id2">
<h3>b. Application<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;storage_options&quot;</span><span class="p">:</span> <span class="n">storage_options</span><span class="p">,</span>
    <span class="s2">&quot;scratch_root&quot;</span><span class="p">:</span> <span class="n">s3_dest</span><span class="p">,</span>  <span class="c1"># in the notebook, the remote root is defined with the variable `scratch_root`</span>
    <span class="c1"># URL to the reference data</span>
    <span class="s2">&quot;ref_url&quot;</span><span class="p">:</span> <span class="s2">&quot;s3://gfts-reference-data/NORTHWESTSHELF_ANALYSIS_FORECAST_PHY_004_013/combined_2022_to_2024.parq/&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">tag_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A19124&quot;</span><span class="p">,</span> <span class="s2">&quot;A18831&quot;</span><span class="p">,</span> <span class="s2">&quot;A18832&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">tag_name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">tag_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing tags&quot;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># remotes from the tag name any conflicting characters (such as &quot;_&quot;) with Kubernetes</span>
        <span class="n">safe_tag_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-z0-9-]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tag_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="c1"># parameters (with `tag_name`)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parameters</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;tag_name&quot;</span><span class="p">:</span> <span class="n">tag_name</span><span class="p">}</span>
        <span class="c1"># where to store the notebook remotely</span>
        <span class="n">s3_nb_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s3_nb_dest</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">.ipynb&quot;</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">kbatch_papermill</span><span class="p">(</span>
            <span class="c1"># input info</span>
            <span class="n">code_dir</span><span class="o">=</span><span class="n">code_dir</span><span class="p">,</span>
            <span class="n">notebook</span><span class="o">=</span><span class="n">notebook</span><span class="p">,</span>
            <span class="c1"># output info</span>
            <span class="n">s3_dest</span><span class="o">=</span><span class="n">s3_nb_path</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="c1"># additional parameters (not explained here)</span>
            <span class="n">job_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tuto-</span><span class="si">{</span><span class="n">safe_tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># name of the job (here, w.r.t the name of the tag)</span>
            <span class="n">s3_code_dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;gfts-ifremer/kbatch/</span><span class="si">{</span><span class="n">user_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># where to zip and dump the code for the container</span>
            <span class="n">profile_name</span><span class="o">=</span><span class="s2">&quot;big60&quot;</span><span class="p">,</span>  <span class="c1"># specification of the container&#39;s hardware</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Notebook for the tag &quot;</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s1">&quot; has been launched as the job &quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1">&quot;!&#39;</span>
        <span class="p">)</span>

        <span class="c1"># we keep the remote paths of the launched jobs</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">s3_nb_path</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error for </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saves the jobs&#39; metadata in the local folder</span>
<span class="n">dict_path</span> <span class="o">=</span> <span class="n">local_output</span> <span class="o">/</span> <span class="s2">&quot;jobs.json&quot;</span>
<span class="k">with</span> <span class="n">dict_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">job_dict</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><em>You can monitor the status of the jobs with the following cell:</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_job_status</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>When the jobs are finished, you can fetch the notebooks locally with the remote accessor <code class="docutils literal notranslate"><span class="pre">s3</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s3</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s3_nb_dest</span><span class="si">}</span><span class="s2">/*&quot;</span><span class="p">,</span> <span class="n">local_output</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As for the the results of each notebook (or tag), they are stored next <code class="docutils literal notranslate"><span class="pre">s3_nb_dest</span></code>, under <code class="docutils literal notranslate"><span class="pre">s3_dest</span></code>.
You can explore them with the <code class="docutils literal notranslate"><span class="pre">ls</span></code> function of <code class="docutils literal notranslate"><span class="pre">s3</span></code>:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">s3</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">s3_dest</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="further-readings">
<h3>Further Readings<a class="headerlink" href="#further-readings" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>More information about the results, please check <code class="docutils literal notranslate"><span class="pre">pangeo-fish</span></code>’s <a class="reference external" href="https://pangeo-fish.readthedocs.io/en/latest/notebook.html">tutorial</a>.</p></li>
<li><p>To learn how to parameterize Jupyter notebooks, see <a class="reference external" href="https://papermill.readthedocs.io/en/latest/usage-workflow.html">papermill documentation</a>.</p></li>
</ul>
</section>
<section id="extended-code-explanation">
<h3>Extended Code Explanation<a class="headerlink" href="#extended-code-explanation" title="Link to this heading"></a></h3>
<p>This section aims to provide you with additional explanations of the code.</p>
<p>It targets users who want to gain better knowledge about the <code class="docutils literal notranslate"><span class="pre">kbatch_papermill</span></code> function.</p>
<!-- As such, in the following we assume you have already used on your own the package and are familiar with Python. --><p>The last parameters of <code class="docutils literal notranslate"><span class="pre">kbatch_papermill()</span></code> that are not covered above are the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">s3_code_dir</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">profile_name</span></code></p></li>
</ul>
<p>There is little to add for <code class="docutils literal notranslate"><span class="pre">s3_code_dir</span></code>.
It defines the path to a repository in which the files under <code class="docutils literal notranslate"><span class="pre">code_dir</span></code> are zipped into <code class="docutils literal notranslate"><span class="pre">.zip</span></code> files that is later sent to the kubernetes containers.
Upon the execution of the containers, the <code class="docutils literal notranslate"><span class="pre">.zip</span></code> files are removed.</p>
<p>As for <code class="docutils literal notranslate"><span class="pre">profile_name</span></code>, it defines the specification of the container’s hardware resources.
To see the available profiles of your HPC, open a terminal and run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kbatch<span class="w"> </span>profiles
</pre></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./workflow"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="geolocation_model_execution.html" class="btn btn-neutral float-left" title="2. Estimation of fish locations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="scientific_validation.html" class="btn btn-neutral float-right" title="3. Scientific Validation of the results" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Development Seed, Simula, and Ifremer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>